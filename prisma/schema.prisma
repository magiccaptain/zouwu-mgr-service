generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "operational"]
  // shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model User {
  id                           Int                            @id @default(autoincrement())
  name                         String
  username                     String                         @unique
  password                     String
  phone                        String?                        @unique
  email                        String?                        @unique
  permissions                  String[]                       @default([])
  createdAt                    DateTime                       @default(now())
  updatedAt                    DateTime                       @default(now()) @updatedAt
  needResetPwd                 Boolean?                       @default(true)
  homePage                     String?                        @default("/")
  Session                      Session[]
  SubscriptionRedemptionRecord SubscriptionRedemptionRecord[]

  @@schema("public")
}

model Session {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  expireAt  DateTime
  user      User     @relation(fields: [userId], references: [id])

  @@schema("public")
}

model Broker {
  id          Int           @id @default(autoincrement())
  name        String
  key         String        @unique
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @default(now()) @updatedAt
  FundAccount FundAccount[]
  HostServer  HostServer[]

  @@schema("public")
}

model Company {
  id          Int           @id @default(autoincrement())
  name        String
  key         String        @unique
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @default(now()) @updatedAt
  FundAccount FundAccount[]
  HostServer  HostServer[]
  Product     Product[]

  @@schema("public")
}

// 托管方
model Custodian {
  id        Int       @id @default(autoincrement())
  name      String
  key       String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now()) @updatedAt
  product   Product[]

  @@schema("public")
}

model HostServer {
  id            Int       @id @default(autoincrement())
  name          String
  desc          String?
  market        Market
  host_ip       String?
  ssh_host      String?
  ssh_user      String?
  ssh_port      Int?
  home_dir      String?
  active        Boolean   @default(true)
  is_master     Boolean   @default(false)
  last_check_at DateTime?
  brokerKey     String?
  companyKey    String?
  remark        String?
  // 磁盘总数 G
  disk_total    Int?
  // 磁盘使用 G
  disk_used     Int?
  // 主机名
  hostname      String?
  // 操作系统
  os            String?
  // 操作系统版本
  os_version    String?
  // cpu 型号
  cpu_model     String?
  // cpu 核数
  cpu_cores     Int?
  // 内存大小
  memory_size   Int?

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now()) @updatedAt
  broker         Broker?          @relation(fields: [brokerKey], references: [key])
  company        Company?         @relation(fields: [companyKey], references: [key])
  RemoteCommand  RemoteCommand[]
  OpsWarning     OpsWarning[]
  ProcessMonitor ProcessMonitor[]

  @@unique([market, brokerKey, companyKey, ssh_host, ssh_port])
  @@schema("public")
}

enum StrategyLevel {
  PRODUCT
  FUND_ACCOUNT

  @@schema("public")
}

model StrategyConstant {
  id           Int           @id @default(autoincrement())
  level        StrategyLevel
  val          String
  standardized String
  desc         String?

  // level, standardized, val 唯一
  @@unique([level, standardized, val])
  @@schema("public")
}

model Product {
  id                     Int      @id @default(autoincrement())
  key                    String   @unique
  name                   String
  short_name             String?
  type                   String
  companyKey             String
  active                 Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @default(now()) @updatedAt
  isValuationEnabled     Boolean  @default(true)
  isTradeAnalysisEnabled Boolean  @default(true)
  bizLine                String?
  nominalBenchmarket     String?
  custodianKey           String?

  FundAccount     FundAccount[]
  company         Company           @relation(fields: [companyKey], references: [key])
  custodian       Custodian?        @relation(fields: [custodianKey], references: [key])
  NavCustodian    NavCustodian[]
  NavEst          NavEst[]
  MarginCustodian MarginCustodian[]
  MarginEst       MarginEst[]
  OptionCustodian OptionCustodian[]
  PositionVerify  PositionVerify[]

  @@schema("public")
}

enum TradeApiType {
  XTP
  ATP
  CTP
  KFClient

  @@schema("public")
}

model FundAccount {
  id                     Int                 @id @default(autoincrement())
  account                String              @unique
  brokerKey              String
  productKey             String
  companyKey             String
  type                   FundAccountType     @default(STOCK)
  active                 Boolean             @default(true)
  remark                 String?
  branch                 String?
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @default(now()) @updatedAt
  isTransferEnabled      Boolean             @default(true)
  isTradeAnalysisEnabled Boolean             @default(true)
  ATPConfig              ATPConfig[]
  ExternalFundDatail     ExternalFundDatail?
  broker                 Broker              @relation(fields: [brokerKey], references: [key])
  company                Company             @relation(fields: [companyKey], references: [key])
  product                Product             @relation(fields: [productKey], references: [key])
  InnerFundSnapshot      InnerFundSnapshot[]
  TransferRecord         TransferRecord[]
  XTPConfig              XTPConfig[]
  OpsWarning             OpsWarning[]
  RemoteCommand          RemoteCommand[]
  MarketValue            MarketValue[]
  ProcessMonitor         ProcessMonitor[]
  tradeApiType           TradeApiType?

  executionBenchmark           String?
  executionStrategy            String?
  SubscriptionRedemptionRecord SubscriptionRedemptionRecord[]
  futuresAccountInfos          FuturesAccountInfo[]

  @@schema("public")
}

model XTPConfig {
  id                 Int         @id @default(autoincrement())
  fund_account       String
  market             Market
  ip                 String
  port               Int
  user               String
  password           String
  local_ip           String?     @default("")
  log_level          Int?        @default(4)
  account_key        String
  save_file_path     String?     @default(".")
  software_version   String?     @default("0.0.1")
  heat_beat_interval Int?        @default(3)
  fundAccount        FundAccount @relation(fields: [fund_account], references: [account])

  @@unique([fund_account, market])
  @@schema("public")
}

model ATPConfig {
  id                        Int         @id @default(autoincrement())
  fund_account              String
  market                    Market
  ip                        String
  port                      Int
  spare_ip                  String?
  spare_port                Int?
  user                      String
  password                  String
  branch_id                 String
  cust_id                   String
  cust_password             String
  sh_account_id             String
  sz_account_id             String
  client_name               String
  client_version            String
  client_feature_code       String
  account_mode              Int
  login_mode                Int
  order_way                 String
  reconnect_time            Int?        @default(10)
  heartbeat_interval_milli  Int?        @default(5000)
  connect_timeout_milli     Int?        @default(5000)
  rsa_public_key_path       String?
  encrypt_password_lib_path String?
  fundAccount               FundAccount @relation(fields: [fund_account], references: [account])

  @@unique([fund_account, market])
  @@schema("public")
}

model InnerFundSnapshot {
  id           Int                     @id @default(autoincrement())
  market       Market
  fund_account String
  trade_day    String
  reason       InnerFundSnapshotReason
  balance      Float
  buying_power Float
  frozen       Float
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @default(now()) @updatedAt
  xtp_account  Json?
  atp_account  Json?
  recordId     Int?
  fundAccount  FundAccount             @relation(fields: [fund_account], references: [account])
  record       TransferRecord?         @relation(fields: [recordId], references: [id])

  // 期货专属字段
  ctpData Json?

  @@index([fund_account, market, trade_day(sort: Desc)])
  @@schema("public")
}

model TransferRecord {
  id           Int                 @id @default(autoincrement())
  fund_account String
  trade_day    String
  market       Market
  direction    TransferDirection
  amount       Float
  type         TransferType
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @default(now()) @updatedAt
  createdBy    String?
  snapshots    InnerFundSnapshot[]
  fundAccount  FundAccount         @relation(fields: [fund_account], references: [account])

  @@index([fund_account, market, trade_day(sort: Desc)])
  @@schema("public")
}

model ExternalFundDatail {
  id           Int         @id @default(autoincrement())
  fund_account String      @unique
  balance      Float
  fundAccount  FundAccount @relation(fields: [fund_account], references: [account])

  @@schema("public")
}

model AlphaIndexWeight {
  id         Int      @id @default(autoincrement())
  date       DateTime
  code       String // 指数代码
  symbol     String // 股票代码 688001.SH
  trade_dt   String // 交易日期
  i_weight   Float // 权重
  updatetime DateTime

  @@unique([trade_dt, code, symbol])
  @@schema("public")
}

enum Market {
  SH
  SZ
  STOCK_ALL
  SHFE
  CZCE
  DCE
  CFFEX
  GFEX
  INE

  @@schema("public")
}

enum FundAccountType {
  // 股票账户
  STOCK
  // 期货账户
  FUTURES

  @@schema("public")
}

enum InnerFundSnapshotReason {
  BEFORE_TRADING_DAY
  AFTER_TRADING_DAY
  MIDDLE_TRADING_DAY
  SYNC
  BEFORE_TRANSFER
  AFTER_TRANSFER

  @@schema("public")
}

enum TransferDirection {
  IN
  OUT

  @@schema("public")
}

enum TransferType {
  INNER
  EXTERNAL

  @@schema("public")
}

enum SubscriptionRedemptionDirection {
  SUBSCRIPTION // 申购
  REDEMPTION // 赎回

  @@schema("public")
}

enum OpsTaskType {
  BEFORE_CHECK_HOST_SERVER_DISK
  BEFORE_CHECK_HOST_SERVER_TIME
  BEFORE_SYNC_FUND_ACCOUNT
  AFTER_CHECK_HOST_SERVER_DISK
  AFTER_CHECK_OP_VALUE
  AFTER_ARCHIVE_TRADE_LOG
  AFTER_SYNC_FUND_ACCOUNT
  BEFORE_SYNC_POSITIONS
  AFTER_SYNC_POSITIONS
  AFTER_SYNC_ORDER
  AFTER_SYNC_TRADE
  AFTER_SYNC_LAST_PRICE
  AFTER_PULL_OP_VALUE
  AFTER_PULL_QUOTE_SNAPSHOT
  AFTER_CLEAR_PROCESSES
  AFTER_CALC_MARKET_VALUE
  BEFORE_SYNC_INDEX_WEIGHT
  // 盘后计算盈亏
  AFTER_CALC_PNL
  // 盘前写入资金数据
  BEFORE_WRITE_FUND_DATA

  @@schema("public")
}

model OpsTask {
  id             Int             @id @default(autoincrement())
  type           OpsTaskType
  name           String
  trade_day      String
  remoteCommands RemoteCommand[]
  opsWarnings    OpsWarning[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([trade_day(sort: Desc)])
  @@schema("public")
}

enum OpsWarningStatus {
  PENDING
  MANUAL_DONE
  AUTO_DONE
  AUTO_ERROR

  @@schema("public")
}

enum OpsWarningType {
  // 磁盘检查失败
  DISK_CHECK_FAILED
  // 磁盘空间不足
  DISK_FULL
  // 时间检查失败
  TIME_CHECK_FAILED
  // 时间误差过大
  TIME_ERROR
  OP_VALUE_ERROR
  // 进程未运行
  PROCESS_NOT_RUNNING
  // 进程崩溃
  PROCESS_CRASHED
  // 进程 CPU 使用率过高
  PROCESS_HIGH_CPU
  // 进程内存使用率过高
  PROCESS_HIGH_MEMORY
  // 进程检查失败
  PROCESS_CHECK_FAILED

  @@schema("public")
}

model OpsWarning {
  id              Int              @id @default(autoincrement())
  trade_day       String
  status          OpsWarningStatus @default(PENDING)
  opsTaskId       Int?
  hostServerId    Int?
  remoteCommandId Int?
  fund_account    String?
  text            String?
  type            OpsWarningType?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  opsTask       OpsTask?       @relation(fields: [opsTaskId], references: [id])
  hostServer    HostServer?    @relation(fields: [hostServerId], references: [id])
  fundAccount   FundAccount?   @relation(fields: [fund_account], references: [account])
  remoteCommand RemoteCommand? @relation(fields: [remoteCommandId], references: [id])

  @@index([trade_day(sort: Desc)])
  @@schema("public")
}

enum RemoteCommandStatus {
  PENDING
  DONE
  ERROR

  @@schema("public")
}

enum RemoteCommandType {
  DISK_CHECK
  TIME_CHECK
  FREE_DISK
  QUERY_ACCOUNT
  QUERY_POSITION
  QUERY_ORDER
  QUERY_TRADE
  QUERY_LAST_PRICE
  PULL_OP_VALUE
  PULL_QUOTE_SNAPSHOT
  INNER_TRANSFER
  EXTERNAL_TRANSFER
  ARCHIVE_TRADE_LOG
  PKILL_TRADER_TOOL
  // 未知类型
  UNKNOWN

  @@schema("public")
}

model RemoteCommand {
  id           Int                 @id @default(autoincrement())
  trade_day    String
  cmd          String
  cwd          String?
  code         Int?                @default(-999)
  stdout       String?
  stderr       String?
  hostServerId Int
  opsTaskId    Int?
  fund_account String?
  status       RemoteCommandStatus @default(PENDING)
  type         RemoteCommandType?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  hostServer  HostServer   @relation(fields: [hostServerId], references: [id])
  opsTask     OpsTask?     @relation(fields: [opsTaskId], references: [id])
  fundAccount FundAccount? @relation(fields: [fund_account], references: [account])
  OpsWarning  OpsWarning[]

  @@index([hostServerId, trade_day(sort: Desc)])
  @@schema("public")
}

enum Side {
  BUY
  SELL

  @@schema("public")
}

enum PositionDirection {
  N
  L
  S

  @@schema("public")
}

enum HedgeFlag {
  S
  A
  H

  @@schema("public")
}

model Position {
  id          Int      @id @default(autoincrement())
  tradeDay    String
  fundAccount String
  market      Market
  ticker      String
  brokerKey   String
  productKey  String
  companyKey  String
  totalQty    Int
  sellableQty Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  // 期货专属字段
  // 持仓方向
  posiDirection PositionDirection?
  // 套保标志
  hedgeFlag     HedgeFlag?
  // 其他数据
  ctpData       Json?

  @@unique([tradeDay, fundAccount, market, ticker])
  @@schema("public")
}

enum OffsetFlag {
  O
  C
  T
  F

  @@schema("public")
}

model Order {
  id          Int    @id @default(autoincrement())
  tradeDay    String
  fundAccount String
  market      Market
  ticker      String
  orderApiId  BigInt
  orderRef    BigInt
  price       Float
  quantity    Int
  priceType   Int
  side        Side
  qtyTraded   Int
  qtyLeft     Int
  insertTime  BigInt
  updateTime  BigInt
  cancelTime  BigInt
  status      Int
  brokerKey   String
  productKey  String
  companyKey  String

  // 期货专属字段
  // 开平标志
  offsetFlag OffsetFlag?
  // 套保标志
  hedgeFlag  HedgeFlag?
  // 其他数据
  ctpData    Json?

  @@unique([tradeDay, fundAccount, market, ticker, orderRef])
  @@index([tradeDay, fundAccount, orderApiId])
  @@index([tradeDay, fundAccount, orderRef])
  @@schema("public")
}

model Trade {
  id          Int    @id @default(autoincrement())
  tradeDay    String
  fundAccount String
  market      Market
  ticker      String
  orderApiId  BigInt
  orderRef    BigInt
  tradeId     String
  price       Float
  quantity    Int
  tradeTime   BigInt
  tradeAmount Float
  side        Side
  brokerKey   String
  productKey  String
  companyKey  String

  // 期货专属字段
  // 开平标志
  offsetFlag OffsetFlag?
  // 其他数据
  ctpData    Json?

  @@unique([tradeDay, fundAccount, market, ticker, tradeId])
  @@index([tradeDay, fundAccount, orderApiId])
  @@index([tradeDay, fundAccount, orderRef])
  @@index([tradeDay, fundAccount, tradeId])
  @@schema("public")
}

// 行情简要
model QuoteBrief {
  id                Int      @id @default(autoincrement())
  tradeDay          String
  ticker            String
  market            Market
  // 昨收价
  pre_close_price   Float
  // 收盘价
  close_price       Float
  // 涨停价
  upper_limit_price Float
  // 跌停价
  lower_limit_price Float
  // 证券类型
  security_type     Int
  createdAt         DateTime @default(now())
  updatedAt         DateTime @default(now()) @updatedAt

  // 当日实际收盘价（如果当日收盘价为0，则使用历史最新的收盘价）
  actual_close_price      Float?
  // 当日实际收盘价日期
  actual_close_price_date String?

  @@unique([tradeDay, ticker, market])
  @@schema("public")
}

// 市值表
model MarketValue {
  id               Int     @id @default(autoincrement())
  trade_day        String
  ticker           String
  market           Market
  // 持仓
  position         Int
  // 市值
  value            Float
  // 结算价
  close_price      Float?
  // 结算价日期
  close_price_date String?

  fund_account String

  // 市值占比
  market_value_ratio Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  fundAccount FundAccount @relation(fields: [fund_account], references: [account])

  @@unique([trade_day, fund_account, ticker, market])
  @@schema("public")
}

// 指数权重表
model IndexWeight {
  id         Int      @id @default(autoincrement())
  date       DateTime
  code       String // 指数代码
  symbol     String // 股票代码 688001.SH
  trade_dt   String // 交易日期
  i_weight   Float // 权重
  updatetime DateTime

  @@unique([trade_dt, code, symbol])
  @@schema("public")
}

// 资金账户日盈亏表
model DailyPnl {
  id                        Int      @id @default(autoincrement())
  trade_day                 String
  fund_account              String
  rebalance_return          Float // 换仓回报
  rebalance_pnl             Float // 换仓盈亏
  rebalance_buy_commission  Float // 换仓买手续费
  rebalance_sell_commission Float // 换仓卖手续费
  t0_return                 Float // T0回报
  t0_pnl                    Float // T0盈亏
  t0_buy_commission         Float // T0买手续费
  t0_sell_commission        Float // T0卖手续费
  hold_return               Float // 持仓回报
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @default(now()) @updatedAt

  brokerKey  String
  productKey String
  companyKey String

  @@unique([trade_day, fund_account])
  @@schema("public")
}

// 进程类型枚举
enum ProcessType {
  TRADER // 交易程序
  QUOTE // 行情程序
  COMMUNICATION // 通信程序
  CUSTOM // 自定义进程

  @@schema("public")
}

// 进程状态类型枚举
enum ProcessStatusType {
  RUNNING // 运行中
  STOPPED // 已停止
  ERROR // 检查错误
  NOT_FOUND // 未找到进程

  @@schema("public")
}

// 进程监控配置表
model ProcessMonitor {
  id              Int         @id @default(autoincrement())
  name            String // 进程名称/标识
  start_command   String? // 启动命令
  process_type    ProcessType // 进程类型
  hostServerId    Int // 关联的 HostServer
  fund_account    String? // 如果是交易程序，关联 FundAccount
  // 进程识别方式（支持多种方式）
  process_name    String? // 进程名称（用于 ps 命令匹配）
  command_pattern String? // 命令模式（用于更精确匹配）
  // 配置文件, 可能有多个
  config_files    String[]    @default([]) // 配置文件路径
  log_files       String[]    @default([]) // 日志文件路径
  pid_file        String? // PID 文件路径

  configs Json[] // 配置

  // 监控配置
  active             Boolean   @default(true) // 是否启用监控
  check_interval     Int       @default(60) // 检查间隔（秒）
  monitor_start_time DateTime? // 监控开始时间（可选，用于限制监控时间范围）
  monitor_end_time   DateTime? // 监控结束时间（可选，用于限制监控时间范围）
  // 告警阈值（可选）
  cpu_threshold      Float? // CPU 使用率告警阈值（0-100）
  memory_threshold   Float? // 内存使用率告警阈值（0-100）
  // 元数据
  remark             String? // 备注
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @default(now()) @updatedAt

  hostServer    HostServer      @relation(fields: [hostServerId], references: [id], onDelete: Cascade)
  fundAccount   FundAccount?    @relation(fields: [fund_account], references: [account], onDelete: SetNull)
  ProcessStatus ProcessStatus[]

  @@unique([hostServerId, name])
  @@index([hostServerId, active])
  @@schema("public")
}

// 进程状态表
model ProcessStatus {
  id                Int               @id @default(autoincrement())
  processMonitorId  Int // 关联的进程监控配置
  // 进程状态信息
  status            ProcessStatusType // 进程状态
  pid               Int? // 进程 ID
  ppid              Int? // 父进程 ID
  cmd               String? // 命令
  cpu_percent       Float? // CPU 使用率
  memory_percent    Float? // 内存使用率
  memory_used_mb    Float? // 内存使用量（MB）
  uptime_seconds    Int? // 运行时长（秒）
  start_time        DateTime? // 进程启动时间
  // 检查信息
  trade_day         String // 交易日
  checked_at        DateTime          @default(now()) // 检查时间
  check_duration_ms Int? // 检查耗时（毫秒）
  error_message     String? // 错误信息（如果检查失败）
  // 元数据
  createdAt         DateTime          @default(now())

  processMonitor ProcessMonitor @relation(fields: [processMonitorId], references: [id], onDelete: Cascade)

  @@index([processMonitorId, checked_at(sort: Desc)])
  @@index([checked_at(sort: Desc)])
  @@index([trade_day, checked_at(sort: Desc)])
  @@schema("public")
}

// =============================================================================
// 历史数据与预估数据表
// =============================================================================

// 托管净值表（真实值，从估值表解析）
model NavCustodian {
  id        Int      @id @default(autoincrement())
  fund_abbr String   @db.VarChar(8)
  nav_date  DateTime @db.Date

  // 核心净值
  nav     Decimal @db.Decimal(10, 4)
  cum_nav Decimal @db.Decimal(10, 4)

  // 资本
  con_capital Decimal? @db.Decimal(18, 2)
  net_capital Decimal? @db.Decimal(18, 2)

  // 现金类
  cash          Decimal? @db.Decimal(18, 2)
  cash_interest Decimal? @db.Decimal(18, 2)

  // 期货类
  future_margin Decimal? @db.Decimal(18, 2)
  future_usable Decimal? @db.Decimal(18, 2)

  // 证券类
  stock_usable          Decimal? @db.Decimal(18, 2)
  stock_usable_interest Decimal? @db.Decimal(18, 2)
  stock_mv              Decimal? @db.Decimal(18, 2)
  stock_mv_delisted     Decimal? @db.Decimal(18, 2)

  // 其他
  swap_net_asset Decimal? @db.Decimal(18, 2)
  other_fund     Decimal? @db.Decimal(18, 2)
  redeem         Decimal? @db.Decimal(18, 2)
  expense        Decimal? @db.Decimal(18, 2)
  tax            Decimal? @db.Decimal(18, 2)
  tax_base       Decimal? @db.Decimal(18, 2)

  created_at DateTime @default(now()) @db.Timestamp(0)

  product Product? @relation(fields: [fund_abbr], references: [key])

  @@unique([fund_abbr, nav_date], name: "uk_nav_custodian")
  @@index([fund_abbr], name: "idx_nav_custodian_abbr")
  @@index([nav_date], name: "idx_nav_custodian_date")
  @@map("nav_custodian")
  @@schema("public")
}

// 预估净值表
model NavEst {
  id            Int      @id @default(autoincrement())
  fund_abbr     String   @db.VarChar(8)
  estimate_date DateTime @db.Date

  // 核心净值
  nav     Decimal @db.Decimal(10, 4)
  cum_nav Decimal @db.Decimal(10, 4)

  // 资本
  con_capital Decimal? @db.Decimal(18, 2)
  net_capital Decimal? @db.Decimal(18, 2)

  // 现金类
  cash          Decimal? @db.Decimal(18, 2)
  cash_interest Decimal? @db.Decimal(18, 2)

  // 期货类
  future_margin Decimal? @db.Decimal(18, 2)
  future_usable Decimal? @db.Decimal(18, 2)

  // 证券类
  stock_usable          Decimal? @db.Decimal(18, 2)
  stock_usable_interest Decimal? @db.Decimal(18, 2)
  stock_mv              Decimal? @db.Decimal(18, 2)
  stock_mv_delisted     Decimal? @db.Decimal(18, 2)

  // 其他
  swap_net_asset Decimal? @db.Decimal(18, 2)
  other_fund     Decimal? @db.Decimal(18, 2)
  redeem         Decimal? @db.Decimal(18, 2)
  expense        Decimal? @db.Decimal(18, 2)
  tax            Decimal? @db.Decimal(18, 2)
  tax_base       Decimal? @db.Decimal(18, 2)

  created_at DateTime @default(now()) @db.Timestamp(0)

  product Product? @relation(fields: [fund_abbr], references: [key])

  @@unique([fund_abbr, estimate_date], name: "uk_nav_est")
  @@index([fund_abbr], name: "idx_nav_est_abbr")
  @@index([estimate_date], name: "idx_nav_est_date")
  @@map("nav_est")
  @@schema("public")
}

// 托管保证金表（真实值，从 swap 文件解析）
model MarginCustodian {
  id          Int      @id @default(autoincrement())
  fund_abbr   String   @db.VarChar(8)
  margin_date DateTime @db.Date

  margin         Decimal  @db.Decimal(18, 2)
  net_asset      Decimal  @db.Decimal(18, 2)
  margin_change  Decimal? @db.Decimal(18, 2)
  nextday_margin Decimal? @db.Decimal(18, 2)

  created_at DateTime @default(now()) @db.Timestamp(0)

  product Product? @relation(fields: [fund_abbr], references: [key])

  @@unique([fund_abbr, margin_date], name: "uk_margin_custodian")
  @@index([fund_abbr], name: "idx_margin_custodian_abbr")
  @@index([margin_date], name: "idx_margin_custodian_date")
  @@map("margin_custodian")
  @@schema("public")
}

// 预估保证金表
model MarginEst {
  id            Int      @id @default(autoincrement())
  fund_abbr     String   @db.VarChar(8)
  estimate_date DateTime @db.Date

  margin     Decimal  @db.Decimal(18, 2)
  net_asset  Decimal  @db.Decimal(18, 2)
  short_mv   Decimal? @db.Decimal(18, 2)
  usable     Decimal? @db.Decimal(18, 2)
  add_margin Decimal? @db.Decimal(18, 2)

  created_at DateTime @default(now()) @db.Timestamp(0)

  product Product? @relation(fields: [fund_abbr], references: [key])

  @@unique([fund_abbr, estimate_date], name: "uk_margin_est")
  @@index([fund_abbr], name: "idx_margin_est_abbr")
  @@index([estimate_date], name: "idx_margin_est_date")
  @@map("margin_est")
  @@schema("public")
}

// 期货账户结算表（真实值，从结算单解析）
model OptionCustodian {
  id          Int      @id @default(autoincrement())
  fund_abbr   String   @db.VarChar(8)
  settle_date DateTime @db.Date
  account_id  String   @db.VarChar(32)

  balance  Decimal? @db.Decimal(18, 2)
  usable   Decimal? @db.Decimal(18, 2)
  deposit  Decimal? @db.Decimal(18, 2)
  withdraw Decimal? @db.Decimal(18, 2)

  created_at DateTime @default(now()) @db.Timestamp(0)

  product Product? @relation(fields: [fund_abbr], references: [key])

  @@unique([fund_abbr, settle_date, account_id], name: "uk_option_custodian")
  @@index([fund_abbr], name: "idx_option_custodian_abbr")
  @@index([settle_date], name: "idx_option_custodian_date")
  @@map("option_custodian")
  @@schema("public")
}

// 多空市值验证表
model PositionVerify {
  id          Int      @id @default(autoincrement())
  fund_abbr   String   @db.VarChar(8)
  verify_date DateTime @db.Date

  call_mv     Decimal? @db.Decimal(18, 2) // 多头市值
  put_mv      Decimal? @db.Decimal(18, 2) // 空头市值
  ptc_pct     Decimal? @db.Decimal(10, 6) // 多空比例
  call_adjust Decimal? @db.Decimal(18, 2) // 多头调整金额

  created_at DateTime @default(now()) @db.Timestamp(0)

  product Product? @relation(fields: [fund_abbr], references: [key])

  @@unique([fund_abbr, verify_date], name: "uk_position_verify")
  @@index([fund_abbr], name: "idx_position_verify_abbr")
  @@index([verify_date], name: "idx_position_verify_date")
  @@map("position_verify")
  @@schema("public")
}

// 申赎记录表
model SubscriptionRedemptionRecord {
  id           Int                             @id @default(autoincrement())
  fund_account String
  direction    SubscriptionRedemptionDirection
  amount       Float
  operator     String? // 操作人, user.username
  remark       String? // 备注 
  createdAt    DateTime                        @default(now())
  updatedAt    DateTime                        @default(now()) @updatedAt
  // 减仓日, 赎回时候使用
  reduce_day   String?

  fundAccount  FundAccount @relation(fields: [fund_account], references: [account])
  operatorUser User?       @relation(fields: [operator], references: [username])

  @@index([fund_account, createdAt(sort: Desc)])
  @@schema("public")
}

// 期货账户信息表
model FuturesAccountInfo {
  id             Int         @id @default(autoincrement())
  fund_account   String
  userID         String
  investorID     String
  preMortgage    Decimal     @db.Decimal(18, 2)
  preCredit      Decimal     @db.Decimal(18, 2)
  preBalance     Decimal     @db.Decimal(18, 2)
  deposit        Decimal     @db.Decimal(18, 2)
  withdraw       Decimal     @db.Decimal(18, 2)
  frozenMargin   Decimal     @db.Decimal(18, 2)
  frozenFee      Decimal     @db.Decimal(18, 2)
  currMargin     Decimal     @db.Decimal(18, 2)
  fee            Decimal     @db.Decimal(18, 2)
  closeProfit    Decimal     @db.Decimal(18, 2)
  positionProfit Decimal     @db.Decimal(18, 2)
  balance        Decimal     @db.Decimal(18, 2)
  available      Decimal     @db.Decimal(18, 2)
  tradingDay     String
  updateTime     String
  currencyID     String
  createdAt      DateTime    @default(now())
  FundAccount    FundAccount @relation(fields: [fund_account], references: [account])

  @@unique([fund_account, tradingDay])
  @@index([fund_account], map: "idx_futures_account_info_fund")
  @@index([tradingDay], map: "idx_futures_account_info_day")
  @@schema("public")
}

// 期货持仓表
model FuturesPosition {
  id            Int                @id @default(autoincrement())
  tradeDay      String
  fundAccount   String
  market        Market
  brokerKey     String
  totalQty      Int
  sellableQty   Int
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @default(now())
  companyKey    String
  productKey    String
  ticker        String
  ctpData       Json?
  hedgeFlag     HedgeFlag?
  posiDirection PositionDirection?
  // 结算价
  closePrice    Float?
  // 市值
  notionalValue Float?

  @@unique([tradeDay, fundAccount, market, ticker, posiDirection])
  @@schema("public")
}

// 账户每日交易统计
model AccountDailyStats {
  id          Int    @id @default(autoincrement())
  tradeDay    String // 交易日
  fundAccount String // 账户

  market Market // 市场

  // 资产数据
  netAsset Float // 净资产(万)

  // 交易指标
  turnoverRate Float // 换手率

  // 涨跌数据
  dailyReturn  Float // 日涨跌
  weeklyReturn Float // 周涨跌
  weeklyExcess Float // 周超额

  // 持仓分布
  shRatio Float // 沪市比例

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@unique([tradeDay, fundAccount])
  @@index([tradeDay])
  @@index([fundAccount])
  @@schema("operational")
}

// 期货合约参数表
model FuturesContractParameter {
  id                       Int       @id @default(autoincrement())
  order_book_id            String    @unique // 合约代码，如 Y1001, P1001
  underlying_symbol        String // 标的符号，如 Y, P
  market_tplus             String? // 市场T+
  symbol                   String // 合约名称，如 豆油1001, 棕榈油100
  margin_rate              Float // 保证金率，如 0.05, 0.06
  maturity_date            DateTime? @db.Date // 到期日
  type                     String // 类型，如 Future
  trading_code             String // 交易代码，如 y1001, p1001
  exchange                 Market // 交易所，如 DCE, CZCE, SHFE
  product                  String // 产品类型，如 Commodity
  contract_mult            Int // 合约乘数
  round_lot                Int // 交易单位
  trading_hours            String? // 交易时间
  listed_date              DateTime? @db.Date // 上市日期
  industry_name            String? // 行业名称，如 油脂, 化工
  de_listed_date           DateTime? @db.Date // 退市日期
  underlying_order_book_id String? // 标的合约代码
  start_delivery_date      DateTime? @db.Date // 开始交割日期
  end_delivery_date        DateTime? @db.Date // 结束交割日期

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([order_book_id])
  @@index([underlying_symbol])
  @@index([exchange])
  @@index([maturity_date])
  @@index([listed_date])
  @@index([de_listed_date])
  @@schema("public")
}
